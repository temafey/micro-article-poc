# =============================================================================
# Production Observability Stack - OpenTelemetry + Grafana LGTM + Pyroscope
# =============================================================================
#
# PRODUCTION-READY configuration for the Article Microservice observability stack
#
# Key differences from development:
#   - Anonymous access DISABLED (requires authentication)
#   - Production log levels (info/warning)
#   - Optimized memory limits for production workloads
#   - Retention policies configured
#   - Security hardened
#
# Related Documentation:
#   - ADR-014: docs/adr/ADR-014-observability-stack-modernization.md
#   - Guide: docs/operations/observability/GUIDE.md
#   - Rollback: docs/operations/observability/ROLLBACK.md
#
# Usage:
#   docker compose -f docker-compose.observability-prod.yml up -d
#
# =============================================================================

services:
  # ===========================================================================
  # OpenTelemetry + Grafana LGTM (All-in-One)
  # ===========================================================================
  # Provides: Loki (logs), Grafana (UI), Tempo (traces), Mimir (metrics), OTel Collector
  # Image: grafana/otel-lgtm - production-ready observability stack
  #
  otel-lgtm:
    image: grafana/otel-lgtm:latest
    container_name: ${APP_OTEL_LGTM_NAME:-prod-otel-lgtm}
    restart: unless-stopped
    environment:
      # =======================================================================
      # Grafana Security Configuration (PRODUCTION)
      # =======================================================================
      # CRITICAL: Anonymous access is DISABLED in production
      - GF_AUTH_ANONYMOUS_ENABLED=false

      # Admin credentials (override via secrets in production)
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}

      # Security hardening
      - GF_SECURITY_DISABLE_GRAVATAR=true
      - GF_SECURITY_COOKIE_SECURE=true
      - GF_SECURITY_STRICT_TRANSPORT_SECURITY=true
      - GF_SECURITY_X_CONTENT_TYPE_OPTIONS=true
      - GF_SECURITY_X_XSS_PROTECTION=true

      # =======================================================================
      # Grafana Server Configuration
      # =======================================================================
      - GF_SERVER_ROOT_URL=${GRAFANA_ROOT_URL:-http://localhost:3000}
      - GF_SERVER_DOMAIN=${GRAFANA_DOMAIN:-localhost}

      # =======================================================================
      # Logging Configuration (PRODUCTION)
      # =======================================================================
      # Use 'info' for normal operations, 'warning' for quieter logs
      - GF_LOG_LEVEL=info
      - GF_LOG_MODE=console

      # =======================================================================
      # Retention Policies
      # =======================================================================
      # Loki (Logs) - 30 days retention
      - LOKI_RETENTION_PERIOD=720h
      - LOKI_COMPACTOR_RETENTION_ENABLED=true
      - LOKI_COMPACTOR_RETENTION_DELETE_DELAY=2h
      - LOKI_COMPACTOR_RETENTION_DELETE_WORKER_COUNT=150

      # Tempo (Traces) - 7 days retention
      - TEMPO_RETENTION_PERIOD=168h

      # Mimir (Metrics) - 90 days retention
      - MIMIR_BLOCKS_RETENTION_PERIOD=2160h

      # =======================================================================
      # Performance Tuning
      # =======================================================================
      # Increase limits for production workloads
      - LOKI_INGESTION_RATE_MB=16
      - LOKI_INGESTION_BURST_SIZE_MB=32
      - TEMPO_INGESTION_RATE_SPANS=100000

      # =======================================================================
      # Dashboard Provisioning
      # =======================================================================
      - GF_PATHS_PROVISIONING=/etc/grafana/provisioning
      - GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH=/etc/grafana/provisioning/dashboards/application-overview.json

    ports:
      # Grafana UI (use reverse proxy in production)
      - "${APP_GRAFANA_EXT_PORT:-3000}:3000"
      # OTLP gRPC receiver
      - "${APP_OTLP_GRPC_EXT_PORT:-4317}:4317"
      # OTLP HTTP receiver
      - "${APP_OTLP_HTTP_EXT_PORT:-4318}:4318"
    volumes:
      # Persistent storage for observability data
      - otel_grafana_data:/var/lib/grafana
      - otel_loki_data:/loki
      - otel_tempo_data:/var/tempo
      - otel_mimir_data:/var/mimir
      # Dashboard provisioning
      - ./.docker/grafana/provisioning:/etc/grafana/provisioning:ro
      # Custom Prometheus scrape config
      - ./.docker/grafana/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    networks:
      - observability_net
      - app_net
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          # Increased memory for production workloads
          memory: 2G
        reservations:
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ===========================================================================
  # PostgreSQL Exporter
  # ===========================================================================
  # Exports PostgreSQL metrics to Prometheus/Mimir
  #
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: ${CI_SERVICE_NAME:-prod-micro-article-system}-postgres-exporter
    restart: unless-stopped
    environment:
      # Use service user with limited privileges
      DATA_SOURCE_NAME: "postgresql://${APP_DATABASE_SERVICE_LOGIN:-article_service}:${APP_DATABASE_SERVICE_PASSWORD}@${APP_DATABASE_HOST:-prod-micro-article-system-database}:5432/${APP_DATABASE_NAME:-micro-article-system}?sslmode=disable"
      # Disable default metrics that require superuser
      PG_EXPORTER_DISABLE_DEFAULT_METRICS: "false"
      PG_EXPORTER_DISABLE_SETTINGS_METRICS: "false"
    ports:
      - "9187:9187"
    networks:
      - observability_net
      - app_net
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:9187/metrics || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    depends_on:
      otel-lgtm:
        condition: service_healthy

  # ===========================================================================
  # Redis Exporter
  # ===========================================================================
  # Exports Redis metrics to Prometheus/Mimir
  #
  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: ${CI_SERVICE_NAME:-prod-micro-article-system}-redis-exporter
    restart: unless-stopped
    environment:
      REDIS_ADDR: "redis://${APP_REDIS_HOST:-prod-micro-article-system-redis}:6379"
      # Enable additional metrics for production monitoring
      REDIS_EXPORTER_CHECK_KEYS: "article:*"
      REDIS_EXPORTER_INCL_SYSTEM_METRICS: "true"
    ports:
      - "9121:9121"
    networks:
      - observability_net
      - app_net
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:9121/metrics || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 32M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    depends_on:
      otel-lgtm:
        condition: service_healthy

  # ===========================================================================
  # Webhook Receiver (Alert Delivery)
  # ===========================================================================
  # Receives alerts from Grafana and routes to notification channels
  #
  webhook-receiver:
    image: python:3.12-alpine
    container_name: ${CI_SERVICE_NAME:-prod-micro-article-system}-webhook-receiver
    restart: unless-stopped
    working_dir: /app
    command: >
      sh -c "
        pip install --quiet flask requests &&
        python webhook_server.py
      "
    environment:
      # Alert routing configuration
      FLASK_ENV: production
      WEBHOOK_PORT: 9999
      # External notification endpoints (configure via secrets)
      SLACK_WEBHOOK_URL: ${SLACK_WEBHOOK_URL:-}
      PAGERDUTY_ROUTING_KEY: ${PAGERDUTY_ROUTING_KEY:-}
      EMAIL_SMTP_HOST: ${EMAIL_SMTP_HOST:-}
      EMAIL_SMTP_PORT: ${EMAIL_SMTP_PORT:-587}
      EMAIL_FROM: ${EMAIL_FROM:-alerts@example.com}
      EMAIL_TO: ${EMAIL_TO:-oncall@example.com}
    ports:
      - "9999:9999"
    volumes:
      - ./.docker/webhook-receiver:/app:ro
    networks:
      - observability_net
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:9999/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 32M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    depends_on:
      otel-lgtm:
        condition: service_healthy

  # ===========================================================================
  # Pyroscope (Continuous Profiling)
  # ===========================================================================
  # Continuous CPU and memory profiling for performance analysis
  # Retention: 7 days
  #
  pyroscope:
    image: grafana/pyroscope:latest
    container_name: ${CI_SERVICE_NAME:-prod-micro-article-system}-pyroscope
    restart: unless-stopped
    environment:
      # Retention configuration - 7 days
      PYROSCOPE_RETENTION_PERIOD: "168h"
      # Performance settings
      PYROSCOPE_LOG_LEVEL: info
    ports:
      - "${APP_PYROSCOPE_PORT:-4040}:4040"
    volumes:
      - pyroscope_data:/var/lib/pyroscope
    networks:
      - observability_net
      - app_net
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:4040/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          # Increased memory for production profiling workloads
          memory: 1G
        reservations:
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"

# =============================================================================
# Networks
# =============================================================================
networks:
  observability_net:
    name: ${DOCKER_NETWORK_NAME:-prod_article_net}_observability
    driver: bridge
  app_net:
    name: ${DOCKER_NETWORK_NAME:-prod_article_net}
    external: true

# =============================================================================
# Volumes (Persistent Storage)
# =============================================================================
# IMPORTANT: These volumes contain critical observability data
# Backup strategy recommended for production
#
volumes:
  otel_grafana_data:
    name: ${CI_SERVICE_NAME:-prod}_otel_grafana_data
    driver: local
  otel_loki_data:
    name: ${CI_SERVICE_NAME:-prod}_otel_loki_data
    driver: local
  otel_tempo_data:
    name: ${CI_SERVICE_NAME:-prod}_otel_tempo_data
    driver: local
  otel_mimir_data:
    name: ${CI_SERVICE_NAME:-prod}_otel_mimir_data
    driver: local
  pyroscope_data:
    name: ${CI_SERVICE_NAME:-prod}_pyroscope_data
    driver: local
