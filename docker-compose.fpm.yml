# docker-compose.fpm.yml - PHP-FPM Runtime Overlay
#
# Nginx + PHP-FPM runtime configuration.
# Use with base infrastructure:
#   docker compose -f docker-compose.yml -f docker-compose.fpm.yml -f docker-compose.workers.yml up -d
#
# Port: 80 (HTTP)
#
# Part of Phase 9: Infrastructure Modernization (TASK-029)

services:
  # Nginx Web Server
  test-micro-article-system-nginx:
    container_name: ${CI_SERVICE_NAME}-nginx
    hostname: ${CI_SERVICE_NAME}-nginx
    image: ${DOCKER_SERVER_HOST}/${DOCKER_PROJECT_PATH}/nginx:${DOCKER_IMAGE_VERSION}
    restart: always
    volumes:
      - ./.docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
      - ./:/app:rw
    # Note: API Gateway routing handled by APISIX (see docker-compose.apisix.yml)
    # Traefik labels removed as part of Phase 8 (TASK-024)
    networks:
      - ${DOCKER_NETWORK_NAME}
    ports:
      - "80:80"
    depends_on:
      - test-micro-article-system-rest

  # PHP-FPM Application Server
  test-micro-article-system-rest:
    hostname: ${CI_SERVICE_NAME}-rest
    container_name: ${CI_SERVICE_NAME}-rest
    image: ${DOCKER_SERVER_HOST}/${DOCKER_PROJECT_PATH}/php${DOCKER_PHP_VERSION}-fpm-dev:${DOCKER_IMAGE_VERSION}
    command: 'php-fpm'
    user: 1000:1000
    volumes:
      - ./:/app:rw
      - ~/.composer/cache/:/.composer_cache/:rw
      - ./.docker/php${DOCKER_PHP_VERSION}-fpm-dev/development-config.ini:/usr/local/etc/php/conf.d/development-config.ini
    working_dir: /app
    networks:
      - ${DOCKER_NETWORK_NAME}
    environment:
      # Symfony framework
      APP_ENV: "${APP_ENV:-dev}"
      APP_DEBUG: "${APP_DEBUG:-true}"
      APP_SECRET: "${APP_SECRET}"
      # PHP 8.4 OPcache optimizations
      PHP_OPCACHE_ENABLE: "1"
      PHP_OPCACHE_VALIDATE_TIMESTAMPS: "1"
      PHP_OPCACHE_REVALIDATE_FREQ: "2"
      # JIT disabled in development for Xdebug compatibility
      PHP_OPCACHE_JIT: "${PHP_OPCACHE_JIT:-off}"
      # Xdebug mode (off by default, set to 'debug' in .env to enable)
      XDEBUG_MODE: "${XDEBUG_MODE:-off}"
      # OpenTelemetry configuration (TASK-035)
      OTEL_PHP_AUTOLOAD_ENABLED: "${OTEL_PHP_AUTOLOAD_ENABLED:-true}"
      OTEL_SERVICE_NAME: "${OTEL_SERVICE_NAME:-micro-article-service}"
      OTEL_SERVICE_VERSION: "${OTEL_SERVICE_VERSION:-1.0.0}"
      OTEL_EXPORTER_OTLP_ENDPOINT: "${OTEL_EXPORTER_OTLP_ENDPOINT:-http://test-otel-lgtm:4318}"
      OTEL_EXPORTER_OTLP_PROTOCOL: "${OTEL_EXPORTER_OTLP_PROTOCOL:-http/protobuf}"
      OTEL_TRACES_EXPORTER: "${OTEL_TRACES_EXPORTER:-otlp}"
      OTEL_METRICS_EXPORTER: "${OTEL_METRICS_EXPORTER:-otlp}"
      OTEL_LOGS_EXPORTER: "${OTEL_LOGS_EXPORTER:-otlp}"
      OTEL_RESOURCE_ATTRIBUTES: "${OTEL_RESOURCE_ATTRIBUTES:-service.namespace=micro,deployment.environment=development}"
      OTEL_TRACES_SAMPLER: "${OTEL_TRACES_SAMPLER:-parentbased_always_on}"
      # CRITICAL: Use Cumulative temporality for Prometheus compatibility (TASK-14.5)
      OTEL_EXPORTER_OTLP_METRICS_TEMPORALITY_PREFERENCE: "${OTEL_EXPORTER_OTLP_METRICS_TEMPORALITY_PREFERENCE:-cumulative}"
      # Pyroscope continuous profiling (ADR-014 Phase 4.2)
      PYROSCOPE_ENABLED: "${PYROSCOPE_ENABLED:-true}"
      PYROSCOPE_SERVER_ADDRESS: "${PYROSCOPE_SERVER_ADDRESS:-http://test-micro-article-system-pyroscope:4040}"
      PYROSCOPE_SAMPLE_RATE: "${PYROSCOPE_SAMPLE_RATE:-100}"
      PYROSCOPE_UPLOAD_INTERVAL: "${PYROSCOPE_UPLOAD_INTERVAL:-10}"
    healthcheck:
      test: ["CMD-SHELL", "php-fpm-healthcheck || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    depends_on:
      test-micro-article-system-database:
        condition: service_healthy
      test-micro-article-system-rabbitmq:
        condition: service_started
      test-micro-article-system-redis:
        condition: service_started
