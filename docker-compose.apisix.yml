# docker-compose.apisix.yml - API Gateway (APISIX) Runtime Overlay
#
# Apache APISIX replaces Traefik for API Gateway functionality.
# Provides: rate limiting, authentication, observability, traffic management.
#
# Usage with different PHP runtimes:
#   PHP-FPM:     docker compose -f docker-compose.yml -f docker-compose.apisix.yml -f docker-compose.fpm.yml -f docker-compose.workers.yml up -d
#   RoadRunner:  docker compose -f docker-compose.yml -f docker-compose.apisix.yml -f docker-compose.rr.yml -f docker-compose.workers.yml up -d
#   FrankenPHP:  docker compose -f docker-compose.yml -f docker-compose.apisix.yml -f docker-compose.frank.yml -f docker-compose.workers.yml up -d
#
# Ports:
#   9080  - HTTP API Gateway
#   9443  - HTTPS API Gateway (TLS)
#   9181  - Admin API (9180 used by RoadRunner)
#   9091  - Prometheus metrics
#
# Part of Phase 8: API Gateway Modernization (TASK-023)

services:
  # etcd - Configuration Store for APISIX
  test-micro-article-system-etcd:
    container_name: ${CI_SERVICE_NAME}-etcd
    hostname: ${CI_SERVICE_NAME}-etcd
    image: gcr.io/etcd-development/etcd:v3.5.16
    restart: unless-stopped
    environment:
      ETCD_ENABLE_V2: "true"
      ALLOW_NONE_AUTHENTICATION: "yes"
      ETCD_ADVERTISE_CLIENT_URLS: "http://${CI_SERVICE_NAME}-etcd:2379"
      ETCD_LISTEN_CLIENT_URLS: "http://0.0.0.0:2379"
    volumes:
      - etcd_data:/etcd-data
    networks:
      - ${DOCKER_NETWORK_NAME}
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Apache APISIX - API Gateway
  test-micro-article-system-apisix:
    container_name: ${CI_SERVICE_NAME}-apisix
    hostname: ${CI_SERVICE_NAME}-apisix
    image: apache/apisix:3.14.1-debian
    restart: unless-stopped
    user: root
    volumes:
      - ./apisix/config.yaml:/usr/local/apisix/conf/config.yaml:ro
      - ./apisix/apisix.yaml:/usr/local/apisix/conf/apisix.yaml:ro
      - apisix_logs:/usr/local/apisix/logs
    networks:
      - ${DOCKER_NETWORK_NAME}
    ports:
      # HTTP API Gateway (main traffic)
      - "${APISIX_HTTP_PORT:-9080}:9080"
      # HTTPS API Gateway (TLS traffic)
      - "${APISIX_HTTPS_PORT:-9443}:9443"
      # Admin API (for configuration) - 9181 to avoid conflict with RoadRunner
      - "${APISIX_ADMIN_PORT:-9181}:9180"
      # Prometheus metrics
      - "${APISIX_METRICS_PORT:-9091}:9091"
    environment:
      # Enable standalone mode with config files (routes from apisix.yaml)
      APISIX_STAND_ALONE: "true"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    depends_on:
      test-micro-article-system-etcd:
        condition: service_healthy

  # APISIX Dashboard (Web UI for configuration)
  test-micro-article-system-apisix-dashboard:
    container_name: ${CI_SERVICE_NAME}-apisix-dashboard
    hostname: ${CI_SERVICE_NAME}-apisix-dashboard
    image: apache/apisix-dashboard:3.0-alpine
    restart: unless-stopped
    volumes:
      - ./apisix/dashboard.yaml:/usr/local/apisix-dashboard/conf/conf.yaml:ro
    networks:
      - ${DOCKER_NETWORK_NAME}
    ports:
      # Dashboard Web UI
      - "${APISIX_DASHBOARD_PORT:-9000}:9000"
    depends_on:
      test-micro-article-system-apisix:
        condition: service_healthy

volumes:
  etcd_data:
  apisix_logs:
