# =============================================================================
# Grafana Notification Policies (TASK-037: Alerting & Profiling)
# =============================================================================
# Routing rules for alert notifications.
# Policies determine which contact points receive alerts based on labels.
#
# Routing hierarchy:
#   1. Critical alerts → ops-webhook (immediate notification)
#   2. Platform team alerts → platform-team contact point
#   3. Application team alerts → application-team contact point
#   4. Default → dev-console (for unmatched alerts)
#
# Related: ADR-014-observability-stack-modernization.md
#          docker-compose.observability-dev.yml
# =============================================================================

apiVersion: 1

policies:
  - orgId: 1
    receiver: dev-console
    group_by:
      - grafana_folder
      - alertname
    group_wait: 30s
    group_interval: 5m
    repeat_interval: 4h
    routes:
      # ===========================================================================
      # Critical Severity Route (Priority 1)
      # ===========================================================================
      # All critical alerts go to ops-webhook regardless of team
      - receiver: ops-webhook
        matchers:
          - severity = critical
        group_wait: 10s
        group_interval: 1m
        repeat_interval: 1h
        continue: true  # Also notify team-specific contact

      # ===========================================================================
      # Team-Based Routes (Priority 2)
      # ===========================================================================

      # Platform team: Infrastructure components
      - receiver: platform-team
        matchers:
          - team = platform
        group_by:
          - component
          - alertname
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 4h
        routes:
          # Database alerts - faster notification
          - receiver: platform-team
            matchers:
              - component = database
            group_wait: 15s
            group_interval: 2m
            repeat_interval: 2h

          # Cache alerts
          - receiver: platform-team
            matchers:
              - component = cache
            group_wait: 30s
            group_interval: 5m
            repeat_interval: 4h

          # Messaging alerts
          - receiver: platform-team
            matchers:
              - component = messaging
            group_wait: 30s
            group_interval: 5m
            repeat_interval: 4h

      # Application team: Application-level components
      - receiver: application-team
        matchers:
          - team = application
        group_by:
          - component
          - alertname
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 4h
        routes:
          # API alerts - faster notification
          - receiver: application-team
            matchers:
              - component = api
            group_wait: 15s
            group_interval: 2m
            repeat_interval: 2h

          # Event sourcing alerts
          - receiver: application-team
            matchers:
              - component = event-sourcing
            group_wait: 15s
            group_interval: 2m
            repeat_interval: 2h

      # ===========================================================================
      # Mute Timings (for maintenance windows)
      # ===========================================================================
      # Note: Mute timings can be added here when maintenance windows are scheduled
      # Example:
      # mute_time_intervals:
      #   - name: maintenance-window
      #     time_intervals:
      #       - times:
      #           - start_time: '02:00'
      #             end_time: '04:00'
      #         weekdays: ['saturday', 'sunday']

