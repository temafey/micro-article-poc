; PHP configuration optimized for RoadRunner workers
; RoadRunner runs PHP in CLI mode with long-lived processes

[PHP]

; Memory
; Note: Per-worker memory limit (RoadRunner also enforces max_worker_memory in .rr.yaml)
memory_limit            = 256M

; Error reporting
; Exclude deprecated warnings, notices, and INFO-level messages
error_reporting         = E_ALL & ~E_NOTICE & ~E_STRICT & ~E_DEPRECATED & ~E_WARNING
xmlrpc_errors           = Off
report_memleaks         = On
display_errors          = Off
display_startup_errors  = Off
log_errors              = On
html_errors             = Off

; Logging controls
log_errors_max_len      = 0
ignore_repeated_errors  = On
ignore_repeated_source  = On

date.timezone=UTC

; Xdebug Configuration for PHP 8.4 with RoadRunner
[xdebug]
; Disable Xdebug by default (enable via XDEBUG_MODE env var)
xdebug.mode=off
xdebug.client_host=host.docker.internal
xdebug.client_port=9003
xdebug.start_with_request=trigger
xdebug.idekey=PHPSTORM
xdebug.discover_client_host=false

; OPcache Configuration for RoadRunner
; CRITICAL: opcache.enable_cli=1 is required for RoadRunner workers!
[opcache]
; Enable OPcache for CLI (REQUIRED for RoadRunner)
opcache.enable=1
opcache.enable_cli=1

; Memory configuration (256MB shared memory)
opcache.memory_consumption=256
opcache.interned_strings_buffer=32
opcache.max_accelerated_files=30000

; Revalidation (disable in production for max performance)
; RoadRunner workers are long-lived, so we disable timestamp validation
; Code changes require worker restart (handled by max_jobs or manual restart)
opcache.validate_timestamps=0
opcache.revalidate_freq=0

; File cache (for container restarts and faster worker startup)
opcache.file_cache=/tmp/opcache
opcache.file_cache_only=0
opcache.file_cache_consistency_checks=1

; JIT Configuration (PHP 8.4)
; "tracing" = best for long-running workers (RoadRunner)
opcache.jit=tracing
; JIT buffer size (128MB)
opcache.jit_buffer_size=128M
; JIT optimization level
opcache.jit_max_root_traces=1024
opcache.jit_max_side_traces=256

; Performance tuning
opcache.optimization_level=0x7FFEBFFF
opcache.huge_code_pages=0
opcache.save_comments=1
opcache.fast_shutdown=1

; Preloading (configure for production)
; opcache.preload=/app/config/preload.php
; opcache.preload_user=app
